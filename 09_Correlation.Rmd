# Korelasyon
Değişkenlerin birbiri ile olan ilişkilerini açıklamak çoğu araştırmacının ilgisini çekmiştir. İki değişkene ait çarpımlar toplamı (sum of cross products) $S_{XY}=\sum(X-\bar X)(Y- \bar Y)$ iki değişken arasındaki ilişki hakkında sınırlı olsa da bilgi verebilir. Örneğin Şekil \@ref(fig:zerocrossproduct) X ve Y değişkeni arasındaki ilişkiyi gösterir ve çarpımlar toplamı sıfırdır.


```{r, collapse=T, eval=T, cache=T, message=F,echo=FALSE}
circledat <- function(r = 0.5, ns = 100){
    refs <- seq(0,2*pi,length.out = ns)
    xvar <- 0 + r * cos(refs)
    yvar <- 0 + r * sin(refs)
    return(data.frame(x = xvar, y = yvar))
}
dat <- circledat(r=1,ns = 15)
dat$deviationX=dat$x-mean(dat$x)
dat$deviationY=dat$y-mean(dat$y)
dat$crossPRODUCT=dat$deviationX*dat$deviationY
round(dat,2)
```

```{r zerocrossproduct, message=F,warning=F,echo=F,fig.cap='Çarpımlar toplamı=0'}

library(ggplot2)
ggplot(dat,aes(x,y)) + geom_path()+geom_point(size=2)+
  geom_line(aes(y = 0), size=2) +
  geom_line(aes(x = 0), color='red',size=2)+
  annotate("text", label="positive" , x=0.5, y=0.5, parse=T, fontface =2, size=6)+
  annotate("text", label="negative", x=-0.5  , y=0.5, parse=T, fontface =2, size=6)+
  annotate("text", label="positive", x=-0.5, y=-0.5, parse=T, fontface =2,size=6)+
  annotate("text", label="negative", x=0.5, y=-0.5, parse=T, fontface =2,size=6) 
```

İki değişken arasındaki kovaryans ise  $Cov_{XY}=S_{XY}/n-1$ ile hesaplanabilir. Fakat kovaryans ölçülen değişkenlerin skalasına bağımlıdır.  Bir diğer ifade ile, değişkenlerin sayısal değerleri arttıkça kovaryans artar. Bu durum kovaryans yorumunu zorlaştırır. Bir korelasyon katsayısı ise genellikle -1 ve 1 arasındadır ve sınırları olduğu için yorumlaması daha kolaydır.

## Pearson korelasyon katsayısı
Pearson 1986 yılında bir korelasyon katsayısı hesaplama yöntemi tanıtmıştır. Bu katsayı -1 ile +1 arasında değişir ve $Cov_{XY}/S_X S_Y$ ile hesaplanabilir. Bu katsayı iki değişken arasındaki doğrusal ilişkiyi ölçer. Şekil \@ref(fig:zerocrossproduct) aralarındaki korelasyonun sıfır olduğu iki değişken ile çizilmiştir. Aslında şekil içerisindeki X ve Y bir biri ile ilişkisiz değillerdir çünkü şekil kabaca bir çemberdir. X ve Y beraber bir çember oluşturabilecek ilişkiye sahip oldukları halde , ilişki doğrusal olmadığından, aralarındaki korelasyon sıfırdır.  Şekil \@ref(fig:corsample) aralarında ilişki olan değişkenlere örnekler gösterir,(A) kusursuz pozitif korelasyon, +1, (B) 0.7 pozitif korelasyon, (C) 0 korelasyon, (D) -0.4 korelasyon ve (E) kusursuz negatif korelasyon,-1. 


```{r corsample, echo=FALSE , warning=FALSE, message=FALSE,fig.cap='Correlation examples'}
par(mfrow=c(2,3))
library(mvtnorm)  

kor1=data.frame(X1=seq(0,100,by=1.25),X2=seq(0,80,by=1))
p1=ggplot(kor1, aes(x=X1, y=X2)) +
    geom_point(shape=1,size=2) +   
    geom_smooth(method=lm,   
                se=FALSE,col="red")  +   
   xlab("Toplam puan") +    
   ylab("Doğru yanıt sayısı ")+     
   ggtitle("(A)")
  
kor7=data.frame(rmvnorm(800,mean=c(70,70),sigma=matrix(c(10,7,7,10), ncol=2)))
p2=ggplot(kor7, aes(x=X1, y=X2)) +
    geom_point(shape=1,size=2) +   
    geom_smooth(method=lm,   
                se=FALSE,col="red")  +    
   xlab("araştırma yetkinliği") +    
   ylab("araştırmaya ilgi")  +   
   ggtitle("(B)")


kor0=data.frame(rmvnorm(400,mean=c(70,155),sigma=matrix(c(10,0,0,10), ncol=2)))
p3=ggplot(kor0, aes(x=X1, y=X2)) +
    geom_point(shape=1,size=2) + 
  geom_smooth(method=lm,   
                se=FALSE,col="red")  + 
   xlab("Senelik köpek balığı saldırı sayısı") +    
   ylab("Senelik ekonomik büyüme")  +   
   ggtitle("(C)")

korn4=data.frame(rmvnorm(400,mean=c(70,21),sigma=matrix(c(10,-4,-4,10), ncol=2)))
p4=ggplot(korn4, aes(x=X1, y=X2)) +
    geom_point(shape=1,size=2) + 
  geom_smooth(method=lm,    
                se=FALSE,col="red")  + 
   xlab("Akademik başarı") +   
   ylab("Sınıf öğrenci sayısı")  +   
   ggtitle("(D)")

korn1=data.frame(X1=seq(0,40,by=1),X2=seq(0,-10,by=-0.25))
p5=ggplot(korn1, aes(x=X1, y=X2)) +
    geom_point(shape=1,size=2) +   
    geom_smooth(method=lm,   
                se=FALSE,col="red")  +    
   xlab("yanlış yanıt sayısı") +   
   ylab("Puan")+    
   ggtitle("(E)")

library(gridExtra)
grid.arrange(p1, p2, p3, p4,p5, ncol=3, nrow =2)

```

###Pearson korelasyon katsayısının evren bazında yorumu
Örneklemden gelen bilgi ($r$) , evren ($\rho$) düzeyinde çıkarım yapmak zere kullanılabilir.

__z transformasyonu__ . İkili normallik (bivariate normality) varsayımı ve en az 10 örneklem ile z transformasyonu kullanılarak evrene ait parametre hakkında yorum yapılabilir (@myerswell13). Transformasyon formülü 
$$z_r = \frac{1}{2}ln \left( \frac{1+r}{1-r} \right)$$

Standart hata
$$\sigma_r = \frac{1}{\sqrt{n-3}}$$
Güven aralığı $z_r \pm z_{\alpha / 2} \sigma_r$. Korelasyon katsayısı yorumunu kolaylaştırması amacı ile ters transformasyon $r=\frac{e^{2z_r}-1}{e^{2z_r}+1}$. 

$H_0:\rho=0$ boş hipotezi normal bir dağılımın uygun olduğu varsayımı ile sınanabilir;
$$z=\frac{z_r - z_{\rho_{null}}}{\frac{1}{\sqrt{n-3}}}$$

__t dağılımı__ da $H_0:\rho=0$ boş hipotezini test etmek için kullanılabilir. 

$$t=r\sqrt{\frac{n-2}{1-r^2}}$$

Bu istatistik $n-2$ serbestlik derecesine sahip t dağılımını takip eder.

### R betiği: Pearson korelasyon katsayısı
Gösterim amaçlı dataWBT (\@ref(dataWBT)) içerisinde yer alan Bayburt ilçesi seçilmiştir. TCA puanları ile kişi başı senelik gelir arasındaki korelasyon incelenmiştir.

```{r, collapse=T, eval=T, cache=T, echo=T, message=F}
# CSV yükle
urlfile='https://raw.githubusercontent.com/burakaydin/materyaller/gh-pages/ARPASS/dataWBT.csv'
dataWBT=read.csv(urlfile)

#URL sil
rm(urlfile)

#Bayburt ilini seç
#  sıralı silme uygula (listwise deletion)
dataWBT_Bayburt=dataWBT[dataWBT$city=="BAYBURT",]
#hist(dataWBT_Bayburt$income_per_member)

```

İkili normal dağılım \@ref(fig:testbivarnorm zerinden incelenebilir. _rgl_ (@R-rgl) paketi ile oluşturulan bu grafik interaktiftir, fare ile inceleyiniz.

```{r testbivarnorm, collapse=T, eval=T, cache=F, echo=F, message=F, warning=F, fig.show='hold', fig.cap='Bayburt TCA ve Gelir'}

#kernel yoğunluk
library(MASS)
dataWBT_Bayburt2=na.omit(dataWBT_Bayburt[,c("gen_att","income_per_member")])
kernden <- with(dataWBT_Bayburt2,kde2d(gen_att, income_per_member, n = 100))

library(rgl)
col1 <- rainbow(length(kernden$z))[rank(kernden$z)]

# plot3d(mtcars[, 1:3], type = "s",)  
# plot3d(mtcars[, 4:6], type = "s")

# mfrow3d(nr = 1, nc = 1, sharedMouse = TRUE)  
 open3d()
 persp3d(x=kernden,col=col1)
 rglwidget()


# graph
#persp(kernden, phi = 45, theta = 30)

# graph 2
#persp(kernden, phi = 45, theta = 30, shade = .1, border = NA)
```

İkili normallik varsayımı gerçekci görünmüyor. Karşılaştırmanız amacı ile \@ref(fig:perfectbinorm) korelasyonun 0.7 olduğu bir ikili normal dağılımı gösterir. 
Varsayım ihlalinin sonuçları etkileyebileceğini göz ardı ederek, gösterim amaçlı, eldeki veri ile  $H_0: \rho=0$ boş hipotezi $H_1: \rho \neq0$ alternatif hipotezine karşı test edilmiştir.Saçılım grafiği Şekil \@ref(fig:scatterincgenatt) ile verilmiştir.

```{r perfectbinorm, collapse=T, eval=T, cache=F, echo=F, message=F, warning=F, fig.show='hold', fig.cap='İkili normal dağılım '}
library(mvtnorm)  
kor7=data.frame(rmvnorm(8000,mean=c(0,0),sigma=matrix(c(1,.7,.7,1), ncol=2)))
#kernel densities
library(MASS)
kernden2 <- with(kor7,kde2d(X1, X2, n = 200))
library(rgl)
# graph
#persp(kernden2, phi = 45, theta = 30)

persp(kernden2, phi = 45, theta = 30, shade = .1, border = NA)
```




```{r scatterincgenatt, echo=FALSE , warning=FALSE, message=FALSE,fig.cap='Bayburt TCA ve gelir'}
p1=ggplot(dataWBT_Bayburt2, aes(x=gen_att, y=income_per_member)) +
    geom_point(shape=1,size=2) +   
    geom_smooth(method=lm,   
                se=FALSE,col="blue")  +   
   xlab("TCA") +    
   ylab("Gelir")
p1
```

Bu iki değişken arasındaki korelasyon _stats_ paketinde (@R-base) yer alan _cor_ fonksiyonu ile hesaplanabilir. Aynı paket içerisinde yer alan _cor.test_ fonksiyonu t testi sonuçlarını ve z transformasyonu ile hesaplanmış güven aralığı hesaplarını rapor eder.


```{r, collapse=T, eval=T, cache=F, message=F}
#?cor komutu ile use = "complete.obs" argümanının ikili silme kullandığını görebilirsiniz

with(dataWBT_Bayburt,cor(gen_att,income_per_member,
                         use = "complete.obs",method="pearson"))

with(dataWBT_Bayburt,cor.test(gen_att,income_per_member,
         alternative = "two.sided",
         method="pearson",
         conf.level = 0.95,
         na.action="na.omit"))   
```

Eğer kendiniz hesaplamak isterseniz,  $H_0: \rho=0$ ve $H_0: \rho \neq 0$; 

```{r, eval=T,collapse=TRUE,cache=F, message=F}
sample_r=0.06641641 
r0=0        #boş hipotez
sample_n=137       # örneklem sayısı
zr=(0.5)*log((1+sample_r)/(1-sample_r))  # z transformasyonu
z0=(0.5)*log((1+r0)/(1-r0))  # z transformasyonu
sigmar=1/(sqrt(sample_n-3))

#z istatistiği
(zr-z0)/sigmar


ll=zr-(qnorm(0.975)*sigmar)  # alt limit


ul=zr+(qnorm(0.975)*sigmar)  # üst limit


(exp(2*ll)-1)/(exp(2*ll)+1)  #ters transform
(exp(2*ul)-1)/(exp(2*ul)+1)  #ters transform


t=sample_r*(sqrt((sample_n-2)/(1-sample_r^2)))        
qt(c(.025, .975), df=(sample_n-2))      
p.value = 2*pt(-abs(t), df=sample_n-2)  
p.value
```

Yüzdeli bootstrap yönetimi varsayım ihlallerine dirençli bir yöntem olabilir (@myerswell13).

```{r,collapse=T, eval=T, cache=F,message=F}
#Normallik varsayımı olmadan bootstrap ile %95 güven aralığı hesabı
set.seed(31012017)
B=5000       #  bootstraps tekrarı
alpha=0.05   # alfa

#TCA ve gelir
originaldata=dataWBT_Bayburt2

# id ekle
originaldata$id=1:nrow(originaldata)

output=c()
for (i in 1:B){
  #sample rows
  bs_rows=sample(originaldata$id,replace=T,size=nrow(originaldata))
  bs_sample=originaldata[bs_rows,]
  output[i]=cor(bs_sample$gen_att,bs_sample$income_per_member)
  }
output=sort(output)

## Yönsüz
# alt limit
output[as.integer(B*alpha/2)]

# d yıldız üst
output[B-as.integer(B*alpha/2)+1]


```

Yüzdeli bootstrap dışında alternatif dirençli yöntemler mevcuttur. @wilcox2012 dirençli korelasyon katsayısı hesaplama yöntemlerini bir araya toplamıştır. WRS2 paketi *pbcor* ve _wincor_ fonksiyonları incelenebilir.

```{r,collapse=T, eval=T, cache=F,message=F}
#  WRS2 paketi
library(WRS2)
pbcor(dataWBT_Bayburt2$gen_att,dataWBT_Bayburt2$income_per_member,beta=.2)

wincor(dataWBT_Bayburt2$gen_att,dataWBT_Bayburt2$income_per_member,tr=.2)

```


__Rapor örneği:__ Bayburt ilinde yaşayan katılımcılar göz önünde bulundurularak, TCA puanları ile gelir düzeyi değişkenleri arasında korelasyon olmadığı boş hioptezi test edilmiştir. Pearson korelasyon katsayısı  $r=.066 (p=.44)$ ve bu katsayı için %95 güvern aralığı [-.10,.23] olarak hesaplanmıştır.İki değişken arasında korelasyonun sıfır olduğunu ileri süre boş hipotez terkedilmemiştir. Aynı çıkarıma 5000 tekrarlı boostrap yöntemi ile de ulaşılmıştır (%95 güven aralığı [-.138 to .252 ]). 


__Not: Farklı işaret__ Pearson katsayısı istatistiksel olarak sıfırdan farklı değildirfakat işareti pozitiftir (.066). WRS paketinde yer alan fonksiyonlar da korelasyonun sıfırdan farklı olmadığı sonucuna ulaşmıştır. Fakat hesaplanan korelasyon negatiftir. Gelir değişkenine ait dağılımın çarpık olduğu ikili normallik dağılım grafiğinde de göze çarpmaktadır. World Bank araştırma takımı bu değişkenin çarpık dağılım göstermesi sebebi ile  değişkeni trabnsform ederek analiz etmişlerdir ( @Hirshleifer16). Benzer transformasyonu kullanırsak;

```{r incometransformed, collapse=T, eval=T, cache=F, echo=F, message=F, warning=F, fig.show='hold', fig.cap='Transform edilmiş Gelir '}
# top code 
top=quantile(dataWBT_Bayburt2$income_per_member,.95)
dataWBT_Bayburt2$incomeTC=ifelse(dataWBT_Bayburt2$income_per_member>top,                                               top,dataWBT_Bayburt2$income_per_member)
#transform
dataWBT_Bayburt2$incomeTC=log(dataWBT_Bayburt2$incomeTC+
                                sqrt((dataWBT_Bayburt2$incomeTC^2)+1))

#kernel yoğunluk
library(MASS)
kernden3 <- with(dataWBT_Bayburt2,kde2d(gen_att, incomeTC, n = 100))
library(rgl)
# grafik
#persp(kernden2, phi = 45, theta = 30)

persp(kernden3, phi = 45, theta = 30, shade = .1, border = NA)
```


```{r,collapse=T, eval=T, cache=F,message=F}

with(dataWBT_Bayburt2,cor.test(gen_att,incomeTC,
         alternative = "two.sided",
         method="pearson",
         conf.level = 0.95,
         na.action="na.omit"))  
```

Transformasyon sonucunda gelir değişkeni daha normal bir dağılım göstermiştir ve Pearson korelasyon katsaysının işareti negatiftir.

## Spearman rho ve Kendall tau
Verilerin sıralı veri olması durumunda veya sürekli değişkenlerde aykırı değerlerin etkisi azaltılmak istenildiğinde Spearman rho veya Kendall tau kullanılabilir. Burada bahsedilen aykırı değerlerin etkisinin azaltılması durumu Pearson korelasyona kıyasla geçerlidir. Aykırı değerlere karşı rho ve tauya nazaran daha iyi koruma sağlayan dirençli yöntemler mevcuttur, @wilcox2012.


###R betiği: Spearman’s rho ve Kendall’s tau
Pearson korelasyon katsayısı hesaplama örneğinde kullanılan TCA puanları ve gelir ilişkisi için Spearman rho hesaplaması;

```{r, collapse=T, eval=T, cache=F, message=F}

with(dataWBT_Bayburt,cor.test(gen_att,income_per_member,
         alternative = "two.sided",
         method="spearman",
         conf.level = 0.95,
         na.action="na.omit",
         exact=FALSE)) 

```

Sıralama verisinde eş-sıra (ties) durumu var ise _cor.test_ fonksiyonu Spearman rho hesaplanışında düzeltme yapar fakat p değeri hesaplamaz. Eğer _exact=FALSE_ argümanı kullanılırsa t dağılımı üzerinden p değeri hesaplanabilir. @Andy2012 eş-sıralılık durumunun çok olması durumunda Kendall tau hesaplanmasını önerir.

```{r, collapse=T, eval=T, cache=F, message=F}
#use ?cor to see use="complete.obs" is doing casewise deletion
with(dataWBT_Bayburt,cor.test(gen_att,income_per_member,
         alternative = "two.sided",
         method="kendall",
         conf.level = 0.95,
         na.action="na.omit",
         exact=FALSE)) 

```

_exact=FALSE_ argümanı _method="kendall"_ ile kullanılınca normal dağılım üzerinden p değeri hesaplar.

Gelir değişkeninde bulunan aykırı değerlerin etkisini azaltmak üzere Spearman ve Kendall korelasyon katsayıları hesaplanmıştır. Spearman rho değeri $r_S=-.051 (p=.56)$ ve Kendall tau değeri $\tau = -.037,p=.54$ olarak bulunmuştur.

## R betiği: Çift Serili ve Nokta-Çift Serili Korelasyonlar

Çift serili korelasyon bir sürekli değişken ve örtük bir sürekli değişkeni yansıtan ikili değişken (dichotomous) arasındaki korelasyonu hesaplamak için kullanılabilir. Örneğin öğrencilerin bir soruya verdiği doğru veya yanlış yanıt değişkeni ile toplam puanlar arasındaki ilişki çift serili korelasyon ile hesaplanabilir.  

Gösterim amaçlı veri setinde yer alan birinci TCA sorusunu ikili veri olarak kodlayalım^[World Bank araştırma takımı bu soruyu ikili değişken olarak yeniden kodlayarak analiz etmiştir]. Bu ikili değişken ile 2.,3.,4.,5. ve 6. soruların ortalaması olan TCA puanları arasındaki ilişki _psych_ paketinde (@R-psych) yer alan _biserial_  fonksiyonu ile hesaplanabilir. 

```{r, collapse=T, eval=T, cache=F, message=F}

dataWBT_Bayburt$binitem1=ifelse(dataWBT_Bayburt$item1==4,1,0)
require(psych)
with(dataWBT_Bayburt,biserial(gen_att,binitem1))

```

Nokta çift serili korelasyon ise sürekli bir değişken ve ikili bir değişken arasındaki ilişkiyi ölçmek için kullanılabilir. _cor.test_ fonksiyonu ve _method="pearson"_ argumanı ile nokta çift serili korelasyon hesaplanabilir. TCA puanları ve cinsiyet arasındaki nokta-çift serili korelasyon;

```{r, collapse=T, eval=T, cache=F, message=F}
dataWBT_Kayseri=dataWBT[dataWBT$city=="KAYSERI",]
dataWBT_Kayseri$genderNUM=ifelse(dataWBT_Kayseri$gender=="Female",1,0)
with(dataWBT_Kayseri,cor.test(gen_att,genderNUM,
         alternative = "two.sided",
         method="pearson",
         conf.level = 0.95,
         na.action="na.omit"))   
```



## R betiği: Phi korelasyon katsayısı
Değişkenler ikili ise aralarındaki ilişki phi($\phi$) korelasyon katsayısı ile ölçülebilir. Gösterim amaçlı cinsiyet ve maaş durumu ilişkisi incelenmiştir. Maaş durumu katılımcının son 12 ay boyunca maaş alıp almadığını gösterir. _psych_ paketinde yer alan _phi_ fonksiyonu 2x2 frekans tablosu üzerinden hesaplama yapabilir.


```{r, collapse=T, eval=T, cache=F, message=F}
dataWBT_Kayseri=dataWBT[dataWBT$city=="KAYSERI",]
table(dataWBT_Kayseri$gender,dataWBT_Kayseri$wage01)

genderWAGE=matrix(c(52,49,97,54),ncol=2)
library(psych)
phi(genderWAGE)


```



## Korelasyon katsayısı hakkında dikkat edilmesi gerekenler 


__Sebep-Sonuç__ Bir korelasyon katsayısı sebep-sonuç belirtmez. Sebep-sonuç ilişkisi kurulmak istense dahi dört farklı senaryo mevcuttur, (a) X Y'yi etkiler, (b) Y X'i etkiler, (c) X ve Y bir veya daha fazla ortak sebebin sonucudur, (d) X ve Y farklı sebeplerle ortaya çıkmıştır fakat bu farklı sebepler ilişkilidir.

__Büyüklük__ Bir korelasyon katsayısının büyük veya küçük oluşu konuya göre değişir. Birbirine benzemesi üzerine tasarlanmış iki matematik sınavından sonra hesaplanan korelasyon 0.6 ise bu küçük bir korelasyon olarak düşünülebilir çünkü paralel formlar korelasyonunun en az .70 olması beklenir. Fakat ALES puanları ile yüksek lisans not ortalaması arasında hesaplanacak bir 0.6 korelasyon oldukça büyüktür çünkü alan yazında bu değer genellikle .1 ve .3 arasındadır.

__Aykırı değerler__ Veri setinde yer alan aykırı değerler korelasyon katsayılarını etkiler.

__Güvenirlik__  X veya Y ölçme hatası (measurement error) içeriyorsa hesaplanan korelasyon aşağı yönde etkilenir. 
Düzeltme yapmak için $$r_{T_x T_y}=\frac{r_{xy}}{\sqrt(r_{xx}r_{yy})}$$ kullanılabilir, $r_{xx}$ ve $r_{yy}$ X ve  Y için güvenirlik katsayılarıdır.

• _Bu düzeltme ne zaman kullanılmaz:_ Gerçek hayatta yeri olacak bir karar verilecekse bu düzeltme yapılmamalıdır. Kararlar gözlemlenen veriler üzerine verilmelidir.

• _Bu düzeltme ne zaman kullanılır:_ Teorilerin geliştirilmesi aşamasında düzeltme kullanılabilir.



__Varyans__ Korelasyon katsayısı değişkenlerin varyansından etkilenir. Varyansın yapay olarak küçültülmesi korelasyonun da küçülmesine sebep olur. Varyansın yapay olarak küçülmesine örnekler;

•	Sürekli verilerin kategorize edilmesi 

•	Ranj sınırlılığı

•	Taban ve Tavan etkisi (Floor and Ceiling Effects)


