

# Varyans Analizi (ANOVA)

Varyans analizi (ANOVA) bölümünde kısaca tanıtılan konular; (a) terminoloji, (b) gruplar-arası ANOVA, ve (b) gruplar-içi ANOVA olarak üç başlıktır. Kitabın bir sonraki versiyonunda karma ANOVA (mixed ANOVA) eklenecektir. 


##Terminoloji
Varyans analizi kapsamında kullanılan terimler kısaca açıklanmıştır. Fakat bu bölüm bir önceki bölümde tanıtılan *yaygın tasarılar* (\@ref(commondesigns)) paragraflarının devamıdır.


__Faktör__ Kategorik bağımsız değişkenler ANOVA çerçevesinde faktör olarak isimlendirilir. Önreğin bir önceki bölümde (\@ref(designbetween)) rassal blok tasarısı içerisinde tanımlanan *okuma hızını artırmaya yönelik yeni program* ve *kontrol* grubu üyeliğini belirteniki kategorili (iki alt sınıflı) değişken bir faktör oluşturur. Toplumsal Cinsiyet Algısının (TCA) yüksek öğretim durumuna göre (yüksek öğretim mezunları ve yüksek öğretim mezunu olmayanlar)değişip değişmediğini test eden bir modelde TCA bağımlı değişken, yüksek öğretim durumu ise bir faktördür.  

__Alt sınıf__ Faktörü oluşturan kategorilere alt sınıf denir. TCA örneğinde faktör yüksek öğretim durumudur. Bu faktöre ait alt sınıflar *yüksek öğretim mezunu* ve *yüksek öğretim mezunu değil* olmak üzere iki tanedir. 

__Kesişen faktörler (Crossed factors)__ Bir faktöre ait alt sınıfların diğer bir faktörün bütün alt sınıfları ile kesişmesi durumudur. Tekarlanan ölçümlerin tanıtımı amaçlı bir önceki bölümde verilen örneği düşünelim, 

|               |        İlk kelime                    |
|:-------------:|:-----------------:|:----------------:|
|    Öğrenci    |    Silah         |    Silah Değil   |
|    1          |                   |                  |
|    2          |                   |                  |
| ...           |                   |                  |
|    100        |                   |                  |

Öğrenciler de bir faktör olarak düşünüldüğünde,  her öğrencinin reaksiyon süreleri ilk kelime faktörünün her iki alt sınıfında da ölçülmesi sebebi ile öğrenci ve ilk kelime faktörü kesişmiştir.  

__Kesişmeyen faktörler (Nesting)__ Bir faktöre ait bir alt sınıfın, ikinci faktörün sadece bir alt sınıfında gözlemlenmesi durumudur. Tamamen rassal tasarının tanıtımı amaçlı bir önceki bölümde verilen örneği düşünelim,


|  Makine    |
|----------------------------|---|
| 1                          | 2 |
| $H_1$                      | $H_{n+1}$  |
| $H_2$                      | $H_{n+2}$  |
| $H_3$                      | $H_{n+3}$  |
| ...                      |  |
| $H_n$                      | $H_{2n}$  |

Her bir hasta 1. veya 2. makine ile tedavi edildiğinden, katılımcı faktörü makine faktörünün içinde düşünülür ve faktörler kesişmemiştir.

__Bağlı gözlemler faktörü (Within-subjects factor)__ katılımcı faktörü (öğrenci,çalışan,hasta vb.) ile kesişen faktörlerdir. Tekrarlanan ölçümler örneğinde olduğu gibi her bir katılımcı diğer bir faktörün bütün alt sınıflarında gözlemlenir. Boylamsal çalışmalarda zaman (örneğin öntest, sontest) bağlı gözlemler faktörüne örnektir.

__Bağlı bloklar faktörü__ bloklar ile kesişen faktördür. Rassal blok tasarısını tanıtım amaçlı bir önceki bölümde verilen örneği düşünelim,

|         |               |          |
|:--------:|:-------------:|:-------:|
| Çift     | Yeni Program | Kontrol |
| 1        |               |         |
| 2        |               |         |
|  ...     |               |         |
| ...      |               |         |
| 15       |               |         |

Rassal olmayan blok, kalıtsal ve diyadik tasarılar da bağlı bloklar faktörüne örnektir.

Bağlı gözlemler faktörü ve bağlı bloklar faktörü aynı şekilde analiz edildiğinden çoğu zaman aynı isimle kullanılır, bu bölümde de her iki faktör *bağlı gözlemler* olarak kullanılmıştır.


__Gözlemler arası faktör veya Bağlı olmayan gözlemler faktörü (Between-subjects factor)__ katılımcı faktörü ile kesişmeyen faktörlerdir.  Toplumsal Cinsiyet Algısının (TCA) yüksek öğretim durumuna göre (yüksek öğretim mezunları ve yüksek öğretim mezunu olmayanlar)değişip değişmediğini test eden bir modelde TCA bağımlı değişken, yüksek öğretim durumu ise gözlemler arası faktördür. 


## Bağlı olmayan gözlemler varyans analizi (Between Subjects ANOVA)
Gözlemlerin (katılımcıların) tek bir alt sınıf kombinasyonuna ait olduğu durumlarda yapılan çözümlemelerdir.


### Tek-yönlü bağlı olmayan gözlemler varyans analizi
Tek faktörlü bağlı olmayan gözlemler varyans çözümlemesi  $Y_{ij}=\mu+\alpha_{j}+\epsilon_{ij}$ eşitliğinde yer alan parametrelerin tahmini ile tamamlanabilir. Bu eşitlikte  $Y_{ij}$ _j_ alt sınıfında yer alan _i_ katılımcısına ait  puanı, $\mu$ bütün puanların ortalaması, $\alpha_j$ _j_ alt sınıfının etkisi ve $\epsilon_{ij}$ hata terimidir. $\mu_j=\mu+\alpha_j$'dir, $\mu_j$ _j_ alt sınıfında yer alan katılımcıların aritmetik ortalamasıdır.

Genellikle ilgi  $\alpha_j$ üstünedir, çünkü $\mu_j-\mu$ 'yi temsil eder. Bu ilgi  $H_0: \mu_1 = \mu_2 = \cdots = \mu_j$ boş hipotezinin test edilmesini gerektirir.Alternatif hipotez en az bir alt sınıfa ait ortalamanın farklı olduğunu belirtir. Bu boş hipotez varyansın ayrıştırılması ile test edilebilir. @myerswell13 tarafından verilen notasyon kullanırsak;

| VK   | sd  | KT | KTO | F |
|:-------:|:-----:|:----:|:----:|:---:|
| Toplam | $N-1$ | $\sum_{j=1}^{J}\sum_{i=1}^{n_j}(Y_{ij} - \bar{Y}_{\cdot \cdot})^2$    |   | |
| A     | $J-1$ | $\sum_{j=1}^{J}n_j(\bar{Y}_{\cdot j}-\bar{Y{\cdot \cdot}})^2$         | $SS_A/df_{A}$  | $MS_A/MS_{S/A}$ |
| S/A   | $N-J$ | $\sum_{j=1}^{J}\sum_{i=1}^{n_j}(Y_{ij} - \bar{Y}_{\cdot j})^2$        | $SS_{S/A} / df_{S/A}$  |  |


| VK    | BKTO |
|:-------:|:-----:|
| Toplam |     |
| A     | $\sigma_{S/A}^2 + \frac{1}{J-1} \sum_{j} n_j (\mu_j-\mu)^2$ |
| S/A   | $\sigma_{S/A}^2$   |

VK = vayans kaynağı, sd = serbestlik derecesi, KT = kareler toplamı, KTO = kareler toplamı ortalaması, BKTO = beklenilen kareler toplamı ortalaması.

A , _J_ adet alt sınıfa sahip gruplar arası faktörü, S/A A fatörü içerisindeki katılımcıları, N toplam örneklem sayısını, j=1,...,J faktör alt sınıflarını, i=1,...,$n_j$ katılımcıları, $Y_{ij}$ katılımcı puanlarını, $\bar{Y}_{\cdot \cdot}$ genel ortalamayı, $\bar{Y}_{\cdot j}$ j alt sınıfı katılımcı ortalamasını temsil eder. 

$MS_{A}/ MS_{S/A}$  oranı, boş hipotez doğru olduğunda ve varsayımlar ihlal edilmediğinde, J-1 ve N-J serbestlik derecesine sahip bir F dağılımını takip eder. Dolayısı ile $MS_{A}/ MS_{S/A}$, $F_{\alpha,J-1,N-J}$ kritik değerinden büyük ise boş hipotez terkedilir.


#### Etki büyüklüğü tek-yönlü bağlı olmayan gözlemler varyans analizi
Tanıtımı kolaylaştırmak amaçlı her alt sınıfın eşit sayıda gözlem içerdiğini düşünelim, $n_1=n_2=\cdots=n_j=n$. Bu durumda A faktörü BKTO $\sigma^2+n\theta^2_A$ 'dır ve ;

$$\theta^2_A=\sum_{j=1}^{J}\frac{(\mu-\mu_j)^2}{J-1}$$.

$\theta^2_A$ parametresinin tahmini olan  $\hat\theta^2_A$, $\frac{MS_A-MS_{S/A}}{n}$ ile ve  $\sigma_{S/A}^2$ parametresinin tahmini olan  $\hat\sigma_{S/A}$,  $MS_{S/A}$ ile hesaplanır.

\@ref(indepteff) bölümünde değinildiği gibi, aritmetik ortalamalar arasındaki farkın büyüklüğünü yorumlamak adına etki büyüklüğü hesaplaması yapılabilir. Günümüzde varyans çözümlemesi kullanmış çoğu bilimsel makalede etki büyüklüğü de raporlanmıştır. Bu etki büyüklükleri arasında omega-kare ($\hat\omega^2$), eta-kare ($\hat\eta^2$) ve $f$ en çok raporlananlar arasındadır. 


##### Omega-kare
Omega-kare faktör tarafından açıklanan varyansın toplam varyansa oranını tahmin etmek için türetilmiştir.
$\hat\omega^2=\frac{(J-1)\hat\theta^2/J}{((J-1)\hat\theta^2/J)+\hat\sigma^2_{S/A})}$ 

Omega-kare 0.01 ise küçük, 0.06 ise orta ve 0.14 ise büyük etki olarak yorumlanır @myerswell13.

##### Eta-kare
Eta-kare de , $\hat\eta^2=\frac{SS_A}{SS_{Total}}$,  faktör tarafından açıklanan varyansın toplam varyansa oranını tahmin etmek için türetilmiştir.


Aynı çözümleme için, $\hat\eta^2$ , $\hat\omega^2$  'den büyüktür , çünkü  $\hat\eta^2$, özellikle _n_ küçük ise, pozitif yönde yanlı bir tahmindir. Buna rağmen $\hat\eta^2$ bildiğimiz kadarı ile en çok raporlanan etki büyüklüğüdür. $\hat\eta^2$, regresyon çözümlemesi çerçevesinde $R^2$ olarak da raporlanır.


##### Etki büyüklüğü f
Cohen'in f katsayısı,  $f=\frac{\hat\theta_A}{\hat\sigma_{S/A}}$ ile hesaplanır. Bir f değeri 0.10 ise küçük, 0.25 ise orta, 0.40 ise büyük etki olarak yorumlanır.

##### Etki büyüklüğü hesaplamaları üzerine
Yukarıda verilen örneklerde tanıtımı kolaylaştırmak adına her bir alt sınıfta yer alan gözlem sayısı eşit kabul edilmiştir. Fakat pratikte alt sınıfların katılımcı sayısı genellikle eşit değildir. Aynı zamanda genellikle faktör sayısı birden fazladır. Bunlara ilave olarak, tasarı içerisinde faktörlerin manipüle edilmiş olması veya  ölçülmüş (measured) olması etki büyüklüğü hesaplarını etkiler. Manipule edilen faktörler için rassal (random) ölçülen faktörler için sabit (fixed) faktör isimlendirilmesi de yaygındır. Örneğin TCA puanları rasgele seçilen 10 ilde yaşayan erkek ve kadınlar için hesaplansın. İk faktörlü bu tasarıda iller manipüle edlien faktör, cinsiyet ise ölçülen faktördür.

_ezANOVA_ fonksiyonu (@R-ez) @Bakeman2005 tarafından bir araya getirilen genelleştirilmiş eta-kare (generalized eta-squared) formüllerini kullanarak etki büyüklüğü hesaplar. @Bakeman2005 çalışmasında @olejnikalgina03 tarafından tanımlanan genelleştirilmiş eta kareyi kullanır. Etki büyüklüğünü _R paketi _ezANOVA_ fonksiyonu ile hesaplamak isteyen kullanıcılar _observed_ argümanını incelemeli ve ölçülmüş faktörleri bu argüman ile belirtmelidir. Etki büyüklüğünü R paketleri yerine kod yazarak hesaplamak isteyen araştırmacılar  @olejnikalgina03 tarafından verilen formülleri kullanabilir.


#### Alt sınıf ortalamalarının kıyaslanması (Testing specific contrasts)
Varyans analizi sonrasında veya varyans analizi yerine, ortalamalar ile oluşturulmuş farklı kıyaslamalar test edilebilir. Bu çerçevede kıyas, ağırlıklandırılmış aritmetik ortalamaların toplamdır ve ağırlıkların toplamı sıfırdır. İki sınıf kıyas vardır, ikili kıyaslar var karmaşık kıyaslar. Konuyu tanıtım amaşlı, tek faktörün olduğu bir tasarı düşünelim. Bu tasarıda faktöre ait 3 alt sınıf olsun, bir kontrol grubu ve iki farklı müdahele grubu, $\mu_1$, $\mu_2$, ve $\mu_3$. İkili kıyaslama da bir alt grubun ağırlığı -1, diğer bir alt sınıfın ağırlığı -1 ve üçüncü alt sınıfın 0 olur. Örneğin müdahele gruplarının bir biri ile kıyaslanması için  $(0)\mu_1+(1)\mu_2+(-1)\mu_3$ kullanılabilir. Kontrol grubunun diğer iki müdahele grubunun ortalaması ile kıyaslanması karmaşık kıyaslamaya örnektir ve $(-1) \mu_1+(.5)\mu_2+(.5)\mu_3$ kullanılabilir. Ortalamar arasında fark yoktur boş hipotezini test etmek için;

$$t=\frac{\sum_{j=1}^J(w_j\bar{Y})}{\sqrt{MS_{S/A}\sum_{j=1}^J(\frac{w_j^2}{n_j})}}$$


####  Bütün ikili kıyaslamaların test edilmesi
Bütün ikili kıyaslamaların yapılabileceği bir kaç farklı prosedür vardır. Birden çok kıyaslamanın yapılacağı durumlarda birinci tip hata oranı kontrol edilmelidir. Bu kontrol birinci tip hata oranını belirlenen bir değerde  (örneğin .05) veya daha altında tutmak demektir. En çok kullanılan kontrol yöntemlerinden ikisi (a) kıyaslama bazında (per comparison) hata oranı ve  (b) ortak hata oranıdır (familywise). Kıyaslama bazında kritik değer olarak $\pm t_{(1-\alpha⁄2),N-J}$ kullanıldığında birinci tip hata oranı  $\alpha$'dır. Ortak hata oranı en az bir kıyaslama için birinci tip hata yapılma oranıdır. Eğer bütün ikili kıyaslamalar sıfıra eşitse, ortak hata oranı  $\alpha$ ve $[J(J-1)⁄2]\alpha$ arasındadır. Örneğin 3 alt sınıfı olan bir faktör için yapılacak tüm ikili karşılaştırmalarda birinci tip hata üst limiti $3\alpha$ 'dır. Ortak hata oranını kontrol etmek için birden fazla prosedür vardır. Bu prosdürlerin R ile tamamlanması oldukça kolaydır ve ilerleyen bölümlerde gösterimi yapılmıştır.

##### Trend analizleri
Eklenecek

#### Varsayımlar: tek-yönlü bağlı olmayan gözlemler varyans analizi  {#moreonindependence}
Tek-yönlü bağlı olmayan gözlemler varyans analizi varsayımları bağlı olmayan gruplar t testi varsayımları ile benzerdir.

1.	Yanıtların bağımsızlığı (independence) her alt sınıfta yer alan puanlar birbirinden bağımsız olmalıdır. Yanıtların bağımsızlığını tehdit eden durumlardan biri aynı grup içeresinde yer alan bireylerin birbirlerinin yanıtlarını etkilemesidir. Eğer bir alt sınıfın içerisinde yanıtların bağımsılığını etkileyen gruplaşmalar varsa çözümleme yöntemi değiştirilmelidir. Örneğin çalışma kapsamında ulaşılan katılımcılar sınıf okul şirket gibi kümelerin içerisinde yer alıyor ve bu kümelere müdahil olmak katılımcıların yanıtlarını etkiliyor ise çok düzeyli modeller kullanılabilir. Eğer katılımcılar bir kümeden etkilenmiyorsa fakat faktöre ait alt sınıflar eşleme (matching) yöntemi ile oluşturulmuşsa oluşan bu bağlılığı göz önünde bulundurmak için rassal blok varyans analizi kullanılabilir.


2.	Normallik. Her alt sınıfa ait puanların normal bir dağılımdan geldiği varsayılır. Eğer dağılımların uzun kuyrukları var ise muhtemelen istatistiksel güç azalacaktır. Eğer alt sınıflara ait gözlem sayısı eşit ise normal dağılımdan kopmalar birinci tip hata oranını büyük ölçüde değiştirmez. Bu durum normallikten büyük çapta kopmalar ve küçük örneklem sayıları için geçerli değildir.

3.	Eş varyanslılık: Varyans homojenliği olarak da bilinir. J farklı alt sınıfa ait puanların J farklı evrenden geldiğini fakat J farklı evrenin eşit varyansa sahip olduğu varsayımıdır. Alt sınıflara ait gözlem sayısı eşit ve yeterince büyük değil ise, bu varsayımın ihlali birinci tip hata oranını etkiler. 
Bu varsayımlar sadece özet olarak değinilmiştir. Eğer yanıtların bağımsızlığı zedelenmedi ise, her alt sınıfta eşit sayıda ve en az 20 gözlem var ise ve puanların daağılımı yaklaşık olarak normal ise varyans analizi sonuçları geçerlidir. Diğer durumlarda alternatif analizler kullanılmalıdır. Eğer dirençli analizler ve geleneksel varyans analizi bütün testler için aynı sonuçları veriyorsa geleneksel analizlerin rapor edilmesi araştırmacılar arası iletişimi kolaylaştırmak adına tercih edilebilir.Varyans analizi çerçevesinde dirençli analiz yöntemleri @wilcox2012 tarafından detaylı olarak ele alınmıştır.

#### R betiği:  tek-yönlü bağlı olmayan gözlemler varyans analizi
Gösterim amaçlı, dataWBT'den  (\@ref(dataWBT)) Kocaeli ilinde yaşayan katılımcılar seçilmiştir.
TCA puanları bağımsız değişkeni, eğitim durumu 7 alt sınıflı faktörü oluşturur. Bu alt sınıflar diplomasız, ilkokul, ortaokul, lise, meslek lisesi, önlisans ve lisanstır. Fakat diplomasız katılımcı sadece bir kişi olduğu için bu katılımcı ilkokul alt sınıfına aktarılmıştır. ^[Bu katılımcı analizlerden çıkarılsa da sonuçlar değişmiyor]

Basamak 1: Veri setini hazırla ve betimsel istatistikleri rapor et


```{r, collapse=T, eval=T, cache=T, message=F}

# csv yükle
urlfile='https://raw.githubusercontent.com/burakaydin/materyaller/gh-pages/ARPASS/dataWBT.csv'
dataWBT=read.csv(urlfile)

# URL sil 
rm(urlfile)

#Kocaeli'yi seç
# sıralı silme uygula (listwise deletion)
dataWBT_KOCAELI=na.omit(dataWBT[dataWBT$city=="KOCAELI",
                                c("id","gen_att","education")])


#diplomasız katılımcıyı ilkokul alt sınıfına al
library(car)
dataWBT_KOCAELI$eduNEW <- recode(dataWBT_KOCAELI$education,
                                 "'None'='Primary School (5 years)'")

#kozmetik, faktör etiketini kısalt
dataWBT_KOCAELI$eduNEW <- recode(dataWBT_KOCAELI$eduNEW,
                                 "'High School (Lycee)'=
                                 'High School (Lycee) (4 years)'")

dataWBT_KOCAELI$eduNEW <- recode(dataWBT_KOCAELI$eduNEW,
                                 "'Vocational School'=
                                 'Vocational High School (4 years)'")
# faktör alt sınıflarını görmek için
#table(dataWBT_KOCAELI$eduNEW)

##kozmetik, alt sınıfları sırala
#levels(dataWBT_KOCAELI$eduNEW)
dataWBT_KOCAELI$eduNEW = factor(dataWBT_KOCAELI$eduNEW,
                         levels(dataWBT_KOCAELI$eduNEW)[c(4,3,1,6,2,5)])

# hangi katılımcı diplomasız
#which(dataWBT_KOCAELI$education=="None")

#boş alt sınıfları kaldır
dataWBT_KOCAELI$eduNEW=droplevels(dataWBT_KOCAELI$eduNEW)


#betimsel 
library(psych)
desc1BW=data.frame(with(dataWBT_KOCAELI,
                        describeBy(gen_att, eduNEW,mat=T,digits = 2)),
                        row.names=NULL)


#istenilenleri seç
# Table 1
desc1BW[,c(2,4,5,6,7,13,14)]

# kaydet
#write.csv(desc1BW,file="onewayB_ANOVA_desc.csv")
#write.csv2(desc1BW,file="onewayB_ANOVA_desc.csv")
```


Basamak 2 : Varsayım kontrolü

```{r genattKOCAELI, collapse=T, eval=T, cache=F, message=F, fig.show='hold', fig.cap='Diploma ve TCA '}

require(ggplot2)
ggplot(dataWBT_KOCAELI, aes(x = gen_att)) +
  geom_histogram(aes(y = ..density..),col="black",binwidth = 0.2,alpha=0.7) + 
  geom_density(size=1.5) +
  theme_bw()+labs(x = "Kocaeli Diploma ve TCA")+ facet_wrap(~ eduNEW)+
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=14,face="bold"))

```

Normallikten kopmalar büyük ölçüde değil.

```{r genattKOCAELIbox, collapse=T, eval=T, cache=F, message=F, fig.show='hold', fig.cap='Diploma ve TCA '}

require(ggplot2)
ggplot(dataWBT_KOCAELI, aes(eduNEW,gen_att)) +
  geom_boxplot() + 
  labs(x = "Education",y="Kocaeli Diploma ve TCA")+coord_flip()

```

Varyans homojenliği sorgulanabilir fakat büyük çaplı bir farklılık yok.

Basamak 3 : varyans analizi

Gösterimin kolaylığı açısından varsayımların ihlal edilmediğini düşünelim. _ezANOVA_ fonksiyonu (@R-ez) F testini, levene testini ve etki büyüklüğünü rapor eder. Etki büyüklüğü hesabı modele göre değişir ( Tablo 1 @Bakeman2005 veya @olejnikalgina03). Bu örnekte, Levene testi *alt gruplar için varyanslar eşittir* boş hipotezinin terkedilmesini destekliyor.


```{r, collapse=T, eval=T, cache=T, message=F}

#ez kütüphanesini aktif hale getir
library(ez)

#katılımcı kimliğini belirten id değişkeni faktör olmazsa uyarı verir

dataWBT_KOCAELI$id=as.factor(dataWBT_KOCAELI$id)

# kozmetik, virgülden sonra kaç rakam gösterilsin?
options(digits = 3)


#birinci yol, ezANOVA fonksiyonu

alternative1 = ezANOVA(
    data = dataWBT_KOCAELI,
    wid=id, dv = gen_att, between = eduNEW,observed=eduNEW)

alternative1



# kritik F değeri
qf(.95,5,564)
```


```{r, collapse=T, eval=F, cache=F,echo=T, message=F}

ez fonksiyonu uyarısı hakkında; 
#Warning: Data is unbalanced (unequal N per group). Make sure you specified
#a well-considered value for the type argument to ezANOVA().

bu fonksiyon toplam kareleri 3 farklı şekilde hesaplayabilir.
Tek yönlü varyans analizinde her 3 yöntem de aynı sonucu verir.
Dolayısıyla bu uyarı göz ardı edilebilir.
```


@R-base paketinde yer alan _lm_ fonksiyonu ile aynı sonuçlar elde edilebilir.

```{r, collapse=T, eval=T, cache=F, message=F}

# ikinci yol, lm fonksiyonu
alternative2=lm(gen_att~eduNEW,data=dataWBT_KOCAELI)

#Tablo 2
anova(alternative2)

```

@R-base paketinde yer alan _aov_ fonksiyonu da kullanılabilir.

```{r, collapse=T, eval=T, cache=F, message=F}

#üçüncü yol, aov fonksiyonu
alternative3=aov(gen_att~eduNEW,data=dataWBT_KOCAELI)
summary(alternative3)
```

_pairwise.t.test_ fonksiyonu ikili kıyaslama için oldukça kullanışlıdır. Hangi ortak hata kontrol prosedürünü kullanacağınızı belirledikten sonra _p.adjust.method_ argümanını kullanabilirsiniz. Örneğin _p.adjust.method ="Holm"_ ile @holm1979 tarafından verilen prosedür uygulanabilir. Toplamda 6 farklı prosedür seçilebilir, detaylar için inceleyiniz; _?p.adjust_ 


```{r, collapse=T, eval=T, cache=F, message=F}

# ikili kıyaslamalar
# Tablo 3
with(dataWBT_KOCAELI, pairwise.t.test(gen_att,eduNEW,p.adjust.method ="holm"))

```


#### Dirençli tahminleme yöntemi: tek-yönlü bağlı olmayan gözlemler varyans analizi 
@wilcox2012 tarafından bir araya toplanan dirençli prosedürlerden bir tanesi @R-WRS2 paketi ile kullanılabilecek _t1way_ fonksiyonu ile tamamlanabilir. Kırpılmış ortalamalar için farklı-varyanslı(heteroscedastic) ve tek yönlü ANOVA yöntemini kullanan bu fonksiyonun detayları için inceleyiniz ;_?t1way_ 




```{r, collapse=T, eval=T, cache=F, message=F}
library(WRS2)

#t1way
# 20% kırpılmış
t1way(gen_att~eduNEW,data=dataWBT_KOCAELI,tr=.2,nboot=5000)

# 10% kırpılmış
t1way(gen_att~eduNEW,data=dataWBT_KOCAELI,tr=.1,nboot=5000)

# 5% kırpılmış
t1way(gen_att~eduNEW,data=dataWBT_KOCAELI,tr=.05,nboot=5000)

## heteroscedastic ikili kıyaslamalar

#alt sınıfların sıralanışı
lincon(gen_att~eduNEW,data=dataWBT_KOCAELI,tr=.1)[[2]]
#ikili kıyaslamalar
round(lincon(gen_att~eduNEW,data=dataWBT_KOCAELI,tr=.1)[[1]][,c(1,2,6)],3)

```



#### Örnek rapor: tek-yönlü bağlı olmayan gözlemler varyans analizi
Gösterim amaçlı seçtiğimiz dataWBT alt kümesi ile (Kocaeli şehri) tamamlanan geleneksel ANOVA ve dirençli ANOVA , aynı zamanda ikili karşılaştırma testleri aynı sonuçları vermiştir. Varsayımların ihlalleri büyük çapta olmadığı için bu sonuçlar şaşırtıcı değildir. Bu gibi geleneksel ve dirençli yöntemlerin bütün hipotez testleri için aynı karara götürdüğü durumlarda, geleneksel yöntemlerin raporlanması tercih edilebilir.

TCA puanlarının eğitim durumuna göre değişip değişmediğini test etmek amaçlı varyans çözümlemesi yapılmıştır. Tablo 1 ile bütün eğitim durumları için aritmetik ortalama, standart sapma, örenklem çarpıklığı ve örneklem basıklığı değerleri verilmiştir. Varyans analizi eğitim durumunun TCA puanları üzerinde etkisi olduğu hipotezini desteklemiştir, F(5,564) = 7.27, p < .001, $\hat\eta^2_G=.06$. Bu analizler için ANOVA tablosu Tablo 2 ile verilmiştir. İkili kıyaslamalar ortak hata oranını @holm1979 tarafından verilen prosedüre uygun olarak tamamlanmış sonuçlar Tablo 3 ile verilmiştir. 15 farklı ikili kıyaslamada, ortalamaların farkı 9 kıyaslama için istatistiksel olarak anlamlı bulunmuştur (tespit edilen farklılıklar detaylı olarak açıklanabilir.) Model varsayımları kontrol edilmiş, büyük çaplı bir ihlal tespit edilmemiş olmasına rağmen dirençli yöntemlerden kırpılmış ortalamalar için farklı-varyanslı ANOVA (@R-WRS2) prosedürü ile sonuçlar karşılaştırılmış ve bir farklılık olmadığı görülmüştür.


#### Kayıp data teknikleri: tek-yönlü bağlı olmayan gözlemler varyans analizi
To be added

#### İstatistiksel güç hesapları: tek-yönlü bağlı olmayan gözlemler varyans analizi
To be added

### İki faktörlü bağlı olmayan gözlemler varyans analizi
Bu başlık altında iki bağlı olmayan faktörlü varyans analizi ele alınmıştır. Faktörlerden ilki J alt sınıfa sahip A faktörü, ikincisi K alt sınıfa sahip B faktörü olarak düşünülmüştür. Bu durumda JK farklı alt sınıf kombinasyonu oluşur. Her bir gözlemin bir ve yalnız bir alt sınıf kombinasyonunda yer alması ve alt sınıfların bir birine eşlenmesi söz konusu olmadığından, bu tasarı bağlı olmayan gözlemler varyans çözümlemesine uygundur.En bait halinde, her iki faktör sadece 2 alt sınıfa sahiptir. Örneğin TCA puanlarına ait varyans cinsiyet ve yüksek öğretim durumuna göre çözümlenirse aşağıda yer alan tablo oluşur.


|        | Lise ve altı | Yüksek öğretim |            |
|:------:|:-----------:|:-------:|:----------:|
| Kadın |     $\mu_{11}$        |    $\mu_{12}$       | $\mu_{1\cdot}$  |
| Erkek   |     $\mu_{21}$        |    $\mu_{22}$       | $\mu_{2\cdot}$  |
|        | $\mu_{\cdot 1}$       |    $\mu_{\cdot 2}$  |                 |


Bu tasarıda hipotez testlerinde kullanılan artitmetik ortalamar $\mu_{11}, \mu_{12}, \mu_{21},\mu_{22}$, satır ortalamaları $\mu_{1 \cdot}$, $\mu_{2 \cdot}$ ve sütun ortalamaları $\mu_{\cdot 1}$, $\mu_{\cdot 2}$ parametreleri ile gösterilmiştir. Satır veya sütun ortalamalarının genel adı marjinal ortalamadır (kenar veya köşe ortalamarı da denilebilir).

Faktörler arasında etkileşim (interaction) olup olmadığına yönelik kurulacak boş hipotez $H_0: \mu_{11} - \mu_{12} = \mu_{21} - \mu_{22}$. Bu etkileşim aynı zamanda iki basit etkinin de karşılaştırılmasıdır,  $(\mu_{21}−\mu_{11}$ ve $\mu_{22} − \mu_{12})$ ve $H_0: \mu_{21}−\mu_{11}= \mu_{22}- \mu_{12}$ boş hipotezi ile de gösterileblir. Bu boş hipotezlerden biri doğru ise diğeri de doğru, biri yanlış ise diğeri de yanlıştır.

__Etkileşim__ Bu tasarıda ilk test edilen hipotez etkilesşim hipotezidir. Fakat etkileşimi tanımlamadan önce basit etkileri tanımlamak gerekir. Basit etki tek bir satırda veya tek bir sütunda yer alan ortalamarın farkıdır. Kullandığımız örnekte iki çeşit basit etki vardır, cinsiyetin basit etkisi ve yüksek öğretim durmunun basit etkisi.
Her bir basit etkinin de iki çeşidi vardır; cinsiyetin yüksek öğretimliler üzerine basit etkisi ($\mu_{12}$  ve $\mu_{22}$), cinsiyetin yüksek öğretim mezunu olmayanlar üzerine etkisi ($\mu_{11}$  ve $\mu_{21}$). Yüksek öğretimin kadınlar üzerine etkisi ($\mu_{11}$  ve  $\mu_{12}$) ve yüksek öğretimin erkekler üzerine etkisi  ($\mu_{21}$ versus $\mu_{22}$).

__Asıl etkiler__ marjinal ortalamar ile tanımlanan etkilerdir. Cinsiyetin asıl etkisi $\mu_{1\cdot} - \mu_{2\cdot}$ şeklinde gösterilir ve $H_0:\mu_{1\cdot} - \mu_{2\cdot} = 0$ boş hipotezi üzerinden test edilir. Yüksek öğretim etkisi de $H_0:\mu_{\cdot 1} - \mu_{\cdot 2} = 0$ boş hipotezi üzerinden test edilir.

Etkileşim istatistiksel olarak anlamlı olduğunda:

1. Eğer basit etkilerin yönü aynı değil ise asıl etkiyi yorumlamak yanıltıcı olur.
2. Eğer basit etkilerin yönü aynı ise asıl etkiyi yorumlamanın yanıltıcı olup olmadığına araştırmacı karar verir.

Etkileşim istatistiksel olarak anlamlı ve asıl etkileri yorumlamak yanıltıcı ise araştırmacı hücre bazında aritmetik ortalamaları yorumlamalıdır.


__Eşitlik__ İki bağlı olmayan faktör varyans analizi için çözümleme modeli  $Y_{ijk}=\mu+\alpha_{j}+\beta_k + \alpha\beta_{jk}+ \epsilon_{ij}$, olarak verilebilir. $Y_{ijk}$ birinci faktörün _j_ alt sınıfı, ikinci faktörün  _k_  alt sınıfında yer alan _i_ katılımcısının puanını; $\mu$ genel ortalamayı; $\alpha_j$ ilk faktöre ait _j_ alt sınıfının etkisini; $\beta_k$   ikinci faktöre ait _k_ alt sınıfının etkisini; $\alpha\beta_{jk}$ etkileşimi ve $\epsilon_{ij}$ hata terimini temsil eder. 


| SV    | df    | F   |
|:-----:|:-----:|:---:|
| A     | $J-1$ | $\frac{MS_A}{MS_{S/AB}}$    |
| B     | $K-1$ | $\frac{MS_B}{MS_{S/AB}}$    | 
| AB    | $(J-1)(K-1)$ | $\frac{MS_{AB}}{MS_{S/AB}}$|
|S/AB   | $N-JK$|     |
|Total  | $N-1$|      |


#### R betiği: İki faktörlü bağlı olmayan gözlemler varyans analizi
Gösterim amaçlı dataWBTde yer alan Kayseri ili katılımcıları seçilmiştir. TCA puanlarına ait varyans cinsiyet ve yüksek öğretim durumuna göre ayrıştırılmıştır. 

Basamak 1 Veriyi hazırla ve betimsel istatistikleri raporla

```{r, collapse=T, eval=T, cache=T, message=F}

# CSV yükle
urlfile='https://raw.githubusercontent.com/burakaydin/materyaller/gh-pages/ARPASS/dataWBT.csv'
dataWBT=read.csv(urlfile)

#URL sil 
rm(urlfile)

#Kayseri ilini seç
# sıralı silme uygula
dataWBT_Kayseri=na.omit(dataWBT[dataWBT$city=="KAYSERI",c("id","gen_att","higher_ed","gender")])

# Yüksek öğretim etiketlerini değiştir
dataWBT_Kayseri$HEF=droplevels(factor(dataWBT_Kayseri$higher_ed, 
                    levels = c(0,1), 
                    labels = c("non-college", "college")))

#table(dataWBT_Kayseri$gender)
#table(dataWBT_Kayseri$HEF)

#boş alt sınıfları düşür
dataWBT_Kayseri$gender=droplevels(dataWBT_Kayseri$gender)

with(dataWBT_Kayseri,
     table(gender,HEF))


#  kozmetik, virgülden sonra kaç rakam gösterilsin?
options(digits = 3)

#betimsel analizler 
library(doBy)
library(moments)
desc2BW=as.matrix(summaryBy(gen_att~HEF+gender, data = dataWBT_Kayseri, 
          FUN = function(x) { c(n = sum(!is.na(x)),
                                mean = mean(x,na.rm=T), sdv = sd(x,na.rm=T),
                               skw=moments::skewness(x,na.rm=T),                    
                               krt=moments::kurtosis(x,na.rm=T)) } ))
# Tablo 4
desc2BW
#write.csv(desc2BW,file="twowayB_ANOVA_betimsel.csv")

```


Basamak 2: Varsayım kontrolü

```{r genattKayseri, collapse=T, eval=T, cache=F, message=F, fig.show='hold', fig.cap='Kayseri Diploma ve TCA '}

require(ggplot2)
ggplot(dataWBT_Kayseri, aes(x = gen_att)) +
  geom_histogram(aes(y = ..density..),col="black",binwidth = 0.2,alpha=0.7) + 
  geom_density(size=1.5) +
  theme_bw()+labs(x = "Kayseri Diploma ve TCA")+ facet_wrap(~ HEF+gender)+
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=14,face="bold"))

```

Normallikten kopmalar büyük ölçüde değil.

```{r genattKayseribox, collapse=T, eval=T, cache=F, message=F, fig.show='hold', fig.cap='Kayseri Diploma ve TCA'}

require(ggplot2)
ggplot(dataWBT_Kayseri, aes(x=gender, y=gen_att))+
  geom_boxplot()+
  facet_grid(.~HEF)+
  labs(x = "Gender",y="Kayseri Diploma ve TCA")

```

Varyanslar benzer görünüyor.

Basamak 3: Varyans analizi

 _ezANOVA_ fonksiyonu (@R-ez) F testini, Levene testini ve etki büyüklüğünü rapor eder. Etki büyüklüğü hesabı kullanılan modele göre (@Bakeman2005 veya @olejnikalgina03) ve toplam kareler hesaplama yöntemine göre değişir. _type_ argümanı hangi tip toplam kareler hesabı kullanılacağını belirler.



```{r, collapse=T, eval=T, cache=T, message=F}

library(ez)
#katılımcı kimliğini belirten id değişkeni faktör olmazsa uyarı verir

dataWBT_Kayseri$id=as.factor(dataWBT_Kayseri$id)

#birinci yol ezANOVA
alternative1 = ezANOVA(
    data = dataWBT_Kayseri,
    wid=id, dv = gen_att, between = .(HEF,gender),observed=.(HEF,gender),type=2)

alternative1


# Tip III toplam kareler
# alternative1b = ezANOVA(
#     data = dataWBT_Kayseri,
#     wid=id, dv = gen_att, between = HEF+gender,type=3)
# 
# alternative1b

# kritik F değeri
qf(.95,1,248)
```

#### Dirençli tahminleme yöntemi: iki-yönlü bağlı olmayan gözlemler varyans analizi 

@wilcox2012 tarafından bir araya toplanan dirençli prosedürlerden bir tanesi @R-WRS2 paketi ile kullanılabilecek _t2way_ fonksiyonu ile tamamlanabilir. Kırpılmış ortalamalar için farklı-varyanslı(heteroscedastic) ve iki yönlü ANOVA yöntemini kullanan bu fonksiyonun detayları için inceleyiniz ;_?t2way_ 


```{r, collapse=T, eval=T, cache=F, message=F}
library(WRS2)

#t2way
# 20% kırpılmış
t2way(gen_att~HEF*gender,data=dataWBT_Kayseri,tr=.2)

# 10% kırpılmış
t2way(gen_att~HEF*gender,data=dataWBT_Kayseri,tr=.1)

# 5% kırpılmış
t2way(gen_att~HEF*gender,data=dataWBT_Kayseri,tr=.05)

```

#### Örnek rapor: iki-yönlü bağlı olmayan gözlemler varyans analizi
Gösterim amaçlı seçtiğimiz dataWBT alt kümesi ile (Kayseri şehri) tamamlanan geleneksel ANOVA ve dirençli ANOVA aynı sonuçları vermiştir. Varsayımların ihlalleri büyük çapta olmadığı için bu sonuçlar şaşırtıcı değildir. Bu gibi geleneksel ve dirençli yöntemlerin aynı karara götürdüğü durumlarda, geleneksel yöntemlerin raporlanması tercih edilebilir.

Tablo 4 Kayseri ilinde yaşayan katılımcılara ait TCA puanlarını cisiyet ve yüksek öğretim faktörlerine göre raporlamıştır. 2x2 varyans analizi sonuçları raporlanmıştır. F testleri alfa=0.05 ile tamamlanmıştır. Cinsiyet etkisi istatistiksel olarak anlamlı bulunmuştur $F(1,248)=45.39, p<.001$. Yüksek öğretim etkisi anlamlı bulunmuştur, $F(1,248)=6.24, p=.013$. İki faktör arasında etkileşimin mevcut olduğuna dair kanıt bulunamamıştır,$F(1,248)=0.25, p=.617$. _ezANOVA_ (@R-ez) fonksiyonu cinsiyet faktörü için 0.15, yüksek öğretim faktörü için 0.02 genelleştirilmiş eta kare ($\hat\eta^2_G$) değeri hesaplamıştır. Tablo 5 ANOVA sonuçlarını bildirir.


#### Takviye çözümlemeler (Follow-ups): iki-yönlü bağlı olmayan gözlemler varyans analizi
To be added.

##### İkili kıyaslamalar: iki-yönlü bağlı olmayan gözlemler varyans analizi
To be added.

##### Karmaşık kıyaslamalar: iki-yönlü bağlı olmayan gözlemler varyans analizi
To be added.


#### Kayıp veri teknikleri: iki-yönlü bağlı olmayan gözlemler varyans analizi
To be added

#### İstatiksel güç hesapları: iki-yönlü bağlı olmayan gözlemler varyans analizi
To be added


## Bağlı gözlemler varyans analizi
Aynı katılımcıya ait puanlar birden fazla faktör alt sınıfında yer alıyorsa veya aynı katılımcı belirli zaman aralıkları ile tekrar gözlemleniyorsa (repeated measures) bağlı gözlemler varyans çözümlemesi kullanılabilir. Blokların kullanıldığı tasarılarda da kullanılabilir. Bağlı olmayan gözlemler varyans analizi ile karşılaştırıldığında , bu yöntemin varyansın artmasına sebep olabilecek katılımcı farklılıklarını ortadan kaldırabilir. Geride bırakılan bu birey kaynaklı varyans fazlalığı genellikle hatayı azalttığından, istatistiksel gücün artmasını sağlar. Bir diğer ifade ile, örneklem büyüklüğü sabit tutulduğunda, bu yöntem ile farklılıkları tespit edebilme olasılığı daha yüksektir. Bununla beraber bağlı gözlemler her zaman uygun değildir. Örneğin 3 farklı öğretim metodunun karşılaştırılması için aynı birey birden fazla programa müdahil olduğunda, programların etkisi birbirine karışabileceğinden bağlı gözlemler kullanmak uygun değildir.


### Tek-yönlü bağlı gözlemler varyans analizi
Eklemesiz (non-additive) model için eşitlik;
-
\begin{equation} 
  Y_{ij}=\mu + \eta_i + \alpha_j + (\eta \alpha)_{ij} + \epsilon_{ij}
  (\#eq:withinstr)
\end{equation} 

_i_ bireyleri, i=1,…,n; _j_ faktöre ait alt sınıfları, j=1,…,P temsil eder. Y puanları; $\mu$ genel ortalamayı; $\eta_i$ bireye ait ortalamanın genel ortalamadan farkını;  $\alpha_j$ j alt sınıfının genel ortalamadan farkını;  $(\eta \alpha)_ij$ etkileşimi; ve $\epsilon_{ij}$ hata terimini temsil eder. $(\eta \alpha)_ij$ ve $\epsilon_{ij}$ aynı alt indise sahip olduğundan etkileri birbirine karışır.
Genellikle ilgi $\alpha_j$ üzerinedir ve $H_0: \mu_1 = \mu_2 = \cdots = \mu_P$ boş hipotezi test edilir. Alternatif hipotez, en az bir aritmetik ortalamanın farklı olduğunu belirtir. Tek-yönlü bağlı gözlemler varyans analizi tablosu;


| SV            | df           | F   |
|:-------------:|:------------:|:---:|
| Subjects (S)  | $n-1$        |   |
| Waves (A)     | $P-1$        | $\frac{MS_A}{MS_{SA}}$    | 
| SA            | $(n-1)(P-1)$ | |
| Total         | $nP-1$|      | |

__Not: Eklemesizlik__ Eşitlik \@ref(eq:withinstr) içerisinde yer alan $(\eta \alpha)_ij$ parametresinin 0 olmaması durumudur. Bu gerçekçi bir durumdur, çünkü bu parametrenin sıfır olması faktöre ait alt sınıfın bütün bireyleri eşit şekilde etkilemesi demektir. Tekrarlanan ölçümlerde bireylerin zaman içerisinde tamamen aynı puansal değişimi göstermesi anlamına gelir.

Tablo \@ref(tab:tablewithinaov) bir deneye ait verileri gösterir. Bu deneyde bireylerin tükettiği alkol dozu artırılmış ve reaksiyon zamanları ölçülmüştür. 

 

```{r tablewithinaov, tidy=FALSE, cache=T,echo=F}
owadata=data.frame(id=1:8,
                   Alkolyok=c(1,2,2,2,3,3,3,6),
                   ikioz=c(2,3,3,3,4,4,4,5),
                   dortoz=c(5,5,6,6,6,7,7,8),
                   altıoz=c(7,8,8,9,9,10,10,11))

knitr::kable(
  owadata, booktabs = TRUE,
  caption = 'Orijinal Alkol Verisi'
)
```

Alt sınıflara ait ortalama, standart sapma ve bireye ait ortalama aşağıda verilmiştir. Bireye ait ortalama dört alt sınıfın ortalamasıdır.


```{r, collapse=T, eval=T, cache=T, message=F}
# kozmetik virgülden sonraki basamak sayısı
options(digits = 2)

#bireylerin ortalaması
apply(owadata,1, mean)

#alt sınıfların ortalaması
apply(owadata[,-1],2, mean)

#alt sınıfların standart sapması
apply(owadata[,-1],2,sd)

```

Her katılımcının reaksiyon zamanları 4 farklı doz sonrasında da ölçüldüğünden, alkol oranı bağlı gözlem faktörüdür. Her doz alt sınıf çifti için korelasyon hesaplanabilir. Tablo 9.2 ile verilen bu korelasyonlar oldukça yüksektir. Her alt sınıf çifti için kovaryans da hesaplanabilir;

$$Cov_{pp^`}=S_pS_{p^`}r_{pp^`}$$
$p$ ve $p'$ alkol faktörüne ait iki farklı alt sınıfı temsil eder. İlk iki alt sınıf için korelasyon  $r_{02}=0.93$ kovaryans ise $Cov_{02}=1.5*0.9*0.93=1.26$ dir.



```{r alchcor, tidy=FALSE, cache=F,echo=F}
kormatrisi=round(cor(owadata[,-1]),2)

knitr::kable(
  kormatrisi, booktabs = TRUE,
  caption = 'Orijinal Alkol Verisi Korelasyon Katsayıları'
)

```



P = bağlı-gözlemler faktörü alt sınıf sayısı, örneğimizde P=4 ;

$\bar C$  = ortalama kovaryans; örneğimizde $\bar C$ = 1.26.

F istatistiği

$$F_W=\frac{MS_A}{MS_{SA}}=\frac{MS_A}{MS_{S/A}- \bar C}$$
 $MS_A$ ve $MS_{S/A}$ bağlı olmayan faktör analizinde olduğu gibi hesaplanır. _W_ harfi F test istatistiğinin bağlı gözlemler (within) için hesaplandığını gösterir. Kritik değer $F_{\alpha,P-1,(P-1)(n-1)}$ ile hesaplanır. 
 
 Bağlı olmayan gözlemler için $F_B=MS_A/MS_{S/A}$ iken bağlı gözlemlerde hesaplanan $F_W$ korelasyonları dikkate alır.Korelasyon sıfır değil ise aynı veriye uygulandığında  $F_W \geq F_B$ olduğu görülür.


#### Varsayımlar: Tek-yönlü bağlı gözlemler varyans analizi

__Küresellik (Sphericity)__ Kovaryans örüntüsü hakkında bir varsayımdır. Küresellik sağlanırsa her bir tekrarlanan ölçüm çifti farkı için hesaplanan varyans aynıdır.

Örnek kovaryans matrisi;

|  |  $Y_1$  |   $Y_2$  |   $Y_3$  |
|:-:|:---:|:----:|:----:|
| $Y_1$ |  10 |  7.5 |  10  |
| $Y_2$ | 7.5 |  15  | 12.5 |
| $Y_3$ |  10 | 12.5 |  20  |

Küresellik mevcut;

| $Y_p-Y_{p'}$ | $\sigma^2_p + \sigma^2_{p'} - 2\sigma_{pp'}$ |
|:-:|:-:|
| $Y_1-Y_2$ | 10+15-2(7.5)=10 |
| $Y_1-Y_3$ | 10+20-2(10)=10 |
| $Y_2-Y_3$ | 15+20-2(12.5)=10 |

Box epsilon değeri  — küreselliğin ne kadar zedelendiğini ölçer

$$\frac{1}{P-1}\leq \epsilon \leq 1$$

$\epsilon$ parametresinin tahminlerinden iki tanesi Greenhouse-Geisser ($\hat \epsilon$) ve Huynh-Feldtdir ($\tilde{\epsilon}$) .
 $\tilde{\epsilon}$  1'den büyük olabilir; bu durumda  $\tilde{\epsilon}$ 1'e eşitlenir.
 
Küresellik varsayımı ile kritik değer $F_{alpha,(P-1),(n-1)(P-1)}$. 

Küresellik varsayımı ihlal edildi ise yaklaşık kritik değer $F_{alpha,\epsilon (P-1),\epsilon (n-1)(P-1)}$. 


__hataların normal dağılımı__ Eşitlik \@ref(eq:withinstr) içerisinde $\epsilon_{ij}$ ile temsil edilen hataların ortalaması sıfır olan bir normal dağılımdan geldiği varsayılır.

__$\eta_i$ normal dağılımı__ Eşitlik \@ref(eq:withinstr) içerisinde $\eta_i$ ile temsil edilen değerlerin ortalaması sıfır olan bir normal dağılımdan geldiği varsayılır.

Listelenen bu varsayımlar, tekrarlanan ölçümlerin çokdeğişkenli normal dağılımdan (multivariate normal distribution) geldiği anlamındadır.

##### Eklemesizlik ve Küresellik arasındaki ilişki
Varasyımlar $\eta_{i}$ ve $\epsilon_{ij}$ üzerinden tanımlanabilse dahi daha basit bir varsayım tanımı *verilerin çokdeğişkenli normal dağılımdan gelmesi ve küreselliği sağlaması* olarak da yapılabilir.
Eğer çokdeğişkenli normal dağılım varsayımı gerçekci ise ve varyanslar ve kovaryanslar eşit ise (bileşik simetri, compound symmetry) hesaplanacak F testi geceçerlidir.

Eğer eklemelilik (additivity) ve eş varyanslılık mevcut ise bileşik simetri sağlanmış olur. Fakat bileşik simetri küresellik varsayımına nazaran gerçekleşmesi daha zor bir varsayımdır. Verilerin çokdeğişkenli norma varsayımdan geldiği durumlarda küresellik varsayımının ihlal edilmemesi F testinin geçerli olması için yeterlidir. Dolayısı ile küresellik varsayımını kontrol etmek eklemelilik varsayımını kontrol etmekten daha önemlidir. Bununla birlikte, küresellik varsayımının ihlal edilmesi durumunda kritik değer düzeltme prosedürleri mevcut olduğu için eklemelilik varsayımını kontrol etmek gereksizdir.


#### R betiği: Tek-yönlü bağlı gözlemler varyans analizi

Gösterim amaçlı @Daunic12 tarafından toplanan verilerden bir alt küme seçilmiştir. Seçilen sınıfta 17 öğrenci mevcuttur. Bağımlı değişken problem çözme bilgisidir. Öğrencilerin 1 sene arayla problem çözme bilgisi ölçülmüştür. Yüksek puanlar bilginin arttığını gösterir.

Basamak 1 Veriyi hazırla 

```{r, collapse=T, eval=T, cache=T, message=F}

# datayı gir
PSdata=data.frame(id=factor(1:17),
                    wave1=c(20,19,13,10,16,12,16,11,11,14,13,17,16,12,12,16,16),
                    wave2=c(28,27,18,17,29,18,26,21,15,26,28,23,29,18,26,21,22),
                    wave3=c(21,24,14,8,23,15,21,15,12,21,23,17,26,18,14,18,19))
```

Betimsel analizleri raporla

```{r, collapse=T, eval=T, cache=F, message=F}
# kozmetik, basamak sayısını belirle
options(digits = 3)

#veriyi uzun formata çevir
#head(PSdata)
library(tidyr)
data_long = gather(PSdata, wave, PrbSol, wave1:wave3, factor_key=TRUE)

#betimsel analizler
library(doBy)
library(moments)
desc1W=as.matrix(summaryBy(PrbSol~wave, data = data_long, 
          FUN = function(x) { c(n = sum(!is.na(x)),
                                mean = mean(x,na.rm=T), sdv = sd(x,na.rm=T),
                                skw=moments::skewness(x,na.rm=T),                    
                                krt=moments::kurtosis(x,na.rm=T)) } ))
# Tablo 6
desc1W
#write.csv(desc1W,file="onewayW_ANOVA_desc.csv")
#write.csv2(desc1W,file="onewayW_ANOVA_desc.csv")
```

Kovaryans matrisi 

```{r, collapse=T, eval=T, cache=F, message=F}
#  Tablo 7
cov(PSdata[,-1])
```


Basamak 2 Varsayım kontrolü


```{r inhibitbox, collapse=T, eval=T, cache=F, message=F, fig.show='hold', fig.cap='Problem çözme bilgisi'}

ggplot(data_long, aes(x=wave, y=PrbSol))+
  geom_boxplot()+
  labs(x = "Wave",y="Problem çözme bilgisi")

```

Küresellik varsayımını test etmek için _ezANOVA_ tarafından verilen Mauchy testi kullanılmıştır. 



```{r inhibitline, collapse=T, eval=T, cache=F, message=F, fig.show='hold', fig.cap='Problem çözme bilgisi çizgi grafiği'}

require(ggplot2)
ggplot(data_long, aes(x=wave, y=PrbSol, group=id))+
geom_line() + labs(x = "Wave",y="Problem çözme bilgisi")
```

Bu grafik, $\eta \beta_{ij}$'nin sıfır olmayacağı şeklinde yorumlanabilir. _asbio_ paketinde (@R-asbio) yer alan tukey.add.test fonksiyonu $H_0$ _: asıl etkiler ve bloklar eklemeli ilerler_ boş hipotezini test etmek için kullanılabilir. Fakat daha önce beirtildiği gibi bu varsayımın ihlali, küresellik varsayımı ihlal edilmediği veya düzeltmesi yapıldığı sürece, öenmsizdir.


```{r, collapse=T, eval=T, cache=F, message=F}
library(asbio)
with(data_long,tukey.add.test(PrbSol,wave,id))

# eğer eklemelilik mevcut ise  rassal bloklar tasarısı kullanılabilir
#additive=with(data_long,lm(PrbSol~id+wave))
#anova(additive)

```

Tukey eklemelilik testi boş hipotezin terkedilebileceğini dolayısıyla eklemesiz modelin daha uygun olduğunu göstermiştir.

Basamak 3: Varyans analizi (küresellik ve hataların normal dağılımı varsayımı kontrolleri ile birlikte). 


```{r, collapse=T, eval=T, cache=T, message=F}
library(ez)
#birinci yol ezANOVA fonksiyonu

alternative1 = ezANOVA(
    data = data_long,
    wid=id, dv = PrbSol, within = wave,
    detailed = T,return_aov=T)

alternative1

```

```{r inhibitresiduals, collapse=T, eval=T, cache=F, message=F, fig.show='hold', fig.cap='Problem çözme bilgisi hata terimleri'}
PrbSolres=sort(alternative1$aov$id$residuals)
qqnorm(PrbSolres);qqline(PrbSolres)

```

Hataların dağılımı normal sayılabilir.



```{r, collapse=T, eval=T, cache=T, message=F}

# ikinci yol aov fonksiyonu
summary(aov(PrbSol ~ wave + Error(id/wave), data=data_long))

```


#### Dirençli tahminleme yöntemi: tek-yönlü bağlı gözlemler varyans analizi
@wilcox2012 tarafından bir araya toplanan dirençli prosedürlerden bir tanesi @R-WRS2 paketi ile kullanılabilecek _rmanova_ fonksiyonu ile tamamlanabilir. Kırpılmış ortalamalar için farklı-varyanslı(heteroscedastic) ve tek yönlü tekrarlanan ölçümler ANOVA yöntemini kullanan bu fonksiyonun detayları için inceleyiniz ;_?rmanova_ 


```{r, collapse=T, eval=T, cache=F, message=F}
library(WRS2)

#rmanova
# 20% kırpılmış
with(data_long,rmanova(PrbSol,wave,id,tr=.20))

```

#### Example writeup tek-yönlü bağlı gözlemler varyans analizi

Her bir ölçme durumu için betimleyici istatistikler Tablo 6 ile verilmiştir. Kovaryans matrisi tablo 7 ile verilmiştir. Tek-yönlü bağlı gözlemler varyans analizi raporlanmıştır. F testi alfa=0.05 ile tamamlanmıştır. Varsayım ihlali tespit edilmemiştir ve ölçme durumları arasında anlamlı bir fark bulunmuştur. $F(2,32)=61.2, p<.001$, genelleştirilmiş eta kare değeri ($\hat\eta^2_G$) 0.43 olarak hesaplanmıştır.


#### Takviye çözümlemeler: Tek-yönlü bağlı gözlemler varyans analizi
Eklenecek

#### Kayıp veri teknikleri: Tek-yönlü bağlı gözlemler varyans analizi
Eklenecek

#### İstatistiksel güç: Tek-yönlü bağlı gözlemler varyans analizi
Eklenecek


## Karma tasarı (Mixed design)
Eklenecek